<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Editar factura</title>
    <style>
        body {
            font-family: Arial;
            max-width: 900px;
            margin: 20px auto;
            background: #000;
            color: #fff;
        }

        h1 {
            text-align: center;
        }

        form {
            background: #111;
            border: 1px solid #444;
            border-radius: 10px;
            padding: 25px;
        }

        label {
            display: block;
            margin-top: 12px;
            color: #ddd;
        }

        input, textarea {
            width: 100%;
            padding: 8px;
            background: #222;
            border: 1px solid #555;
            color: #fff;
            border-radius: 4px;
            font-size: 14px;
            box-sizing: border-box;   /* ← CLAVE para que no se descuadren */
        }


        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }

        th, td {
            border: 1px solid #444;
            padding: 8px;
        }

        th {
            background: #222;
        }

        .btn {
            padding: 8px 14px;
            border-radius: 4px;
            cursor: pointer;
            border: none;
        }

        .btn-primario {
            background: #1a73e8;
            color: white;
        }

        .btn-secundario {
            background: #444;
            color: white;
        }

        .total-factura {
            text-align: right;
            font-size: 18px;
            margin-top: 10px;
        }
    </style>
</head>
<body>

<h1>Editar factura</h1>

<form method="post">
    {% csrf_token %}

    <label>Fecha</label>
    <input type="date" name="fecha" value="{{ factura.fecha|date:'Y-m-d' }}">

    <label>Proveedor</label>
    <input type="text" name="proveedor" value="{{ factura.proveedor }}">

    <label>N° Factura</label>
    <input type="text" name="numero_factura" value="{{ factura.numero_factura }}">

    <label>Observaciones</label>
    <textarea name="observaciones">{{ factura.observaciones }}</textarea>

    <h2>Productos</h2>

    <table>
        <thead>
            <tr>
                <th>Producto</th>
                <th>Precio</th>
                <th>Acción</th>
            </tr>
        </thead>
        <tbody id="productos-body">

        {% for p in factura.productos.all %}
            <tr class="producto-row">
                <td>
                    <input type="text" name="producto_nombre[]" value="{{ p.nombre_producto }}" required>
                </td>
                <td>
                    <input type="number" name="producto_precio[]" value="{{ p.precio|floatformat:0 }}" class="precio-input" step="1" min="0" required>
                </td>
                <td style="text-align:center;">
                    <button type="button" class="btn btn-secundario" onclick="eliminarFila(this)">X</button>
                </td>
            </tr>
        {% endfor %}

        </tbody>
    </table>

    <button type="button" class="btn btn-secundario" onclick="agregarFila()">+ Agregar producto</button>

    <div class="total-factura">
        Total (visual): $ <span id="totalFactura">0</span>
    </div>

    <div style="margin-top:20px; text-align:center;">
        <button type="submit" class="btn btn-primario">Guardar cambios</button>
        &nbsp;
        <a href="{% url 'resumen_semanal' %}" class="btn btn-secundario" style="text-decoration:none;">Cancelar</a>
    </div>
</form>

<script>
    function agregarFila() {
        const tbody = document.getElementById('productos-body');
        const primeraFila = tbody.querySelector('.producto-row');
        const nuevaFila = primeraFila.cloneNode(true);

        nuevaFila.querySelectorAll('input').forEach(input => input.value = '');

        tbody.appendChild(nuevaFila);
        actualizarTotal();
    }

    function eliminarFila(boton) {
        const fila = boton.closest('.producto-row');
        const tbody = document.getElementById('productos-body');

        if (tbody.querySelectorAll('.producto-row').length > 1) {
            fila.remove();
            actualizarTotal();
        }
    }

    function actualizarTotal() {
        let total = 0;
        document.querySelectorAll('.precio-input').forEach(i => {
            const v = parseInt(i.value);
            if (!isNaN(v)) total += v;
        });

        document.getElementById('totalFactura').textContent = total;
    }

    document.addEventListener('input', actualizarTotal);
    document.addEventListener('DOMContentLoaded', actualizarTotal);
</script>

</body>
</html>

